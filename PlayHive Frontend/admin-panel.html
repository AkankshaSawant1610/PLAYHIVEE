<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | Play Hive</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #ffe6f1, #f7e6ff, #fdf0ff);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .glass {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    th, td { text-align: center; }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="fixed top-0 left-0 w-full bg-white/60 backdrop-blur-xl shadow-sm border-b border-white/40 flex justify-between items-center px-8 py-4 z-40">
    <h1 class="text-2xl font-bold text-[#6a4c93]">ğŸ® Play Hive Admin</h1>
    <a href="index.html" class="text-[#6a4c93] font-semibold hover:text-[#a06cd5]">ğŸ  Back</a>
  </nav>

  <!-- ADMIN LOGIN -->
  <section id="login-section" class="flex justify-center items-center h-screen pt-20">
    <div class="glass p-10 w-[90%] max-w-md text-center">
      <h2 class="text-3xl font-bold text-[#6a4c93] mb-6">ğŸ” Admin Login</h2>
      <input id="admin-email" type="email" placeholder="Admin Email" class="w-full p-3 mb-3 border rounded-lg border-[#cdb4db] bg-white/70">
      <input id="admin-password" type="password" placeholder="Password" class="w-full p-3 mb-4 border rounded-lg border-[#cdb4db] bg-white/70">
      <button onclick="adminLogin()" class="w-full bg-gradient-to-r from-[#ffc8dd] to-[#cdb4db] text-white py-3 rounded-lg font-semibold hover:scale-105 transition">Login</button>
      <p id="login-error" class="text-red-500 mt-3 text-sm"></p>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden">
    <div class="flex pt-20">

      <!-- SIDEBAR -->
      <aside class="w-64 bg-white/40 backdrop-blur-lg h-screen fixed top-16 left-0 border-r border-white/50 p-6 flex flex-col space-y-4 text-[#6a4c93]">
        <button onclick="showSection('users-section')" class="text-left py-2 px-4 rounded-lg hover:bg-[#cdb4db]/40 font-semibold">ğŸ‘¥ Users</button>
        <button onclick="showSection('leaderboard-section')" class="text-left py-2 px-4 rounded-lg hover:bg-[#cdb4db]/40 font-semibold">ğŸ† Leaderboard</button>
        <button onclick="showSection('messages-section')" class="text-left py-2 px-4 rounded-lg hover:bg-[#cdb4db]/40 font-semibold">ğŸ’¬ Messages</button>
        <button onclick="logout()" class="text-left py-2 px-4 mt-10 rounded-lg bg-[#ffc8dd] text-[#6a4c93] font-semibold hover:bg-[#fbb1d3] transition">ğŸšª Logout</button>
      </aside>

      <!-- CONTENT -->
      <main class="ml-64 p-8 w-full space-y-10">

        <!-- USERS SECTION -->
        <section id="users-section" class="glass p-6 shadow-lg">
          <h2 class="text-2xl font-semibold text-[#6a4c93] mb-4">ğŸ‘¥ All Users</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white/70 rounded-xl">
              <thead class="bg-[#cdb4db]/50">
                <tr>
                  <th class="py-2 px-4 border-b">ID</th>
                  <th class="py-2 px-4 border-b">Username</th>
                  <th class="py-2 px-4 border-b">Email</th>
                  <th class="py-2 px-4 border-b">Score</th>
                  <th class="py-2 px-4 border-b">Level</th>
                  <th class="py-2 px-4 border-b">Last Updated</th>
                  <th class="py-2 px-4 border-b">Action</th>
                </tr>
              </thead>
              <tbody id="users-table"></tbody>
            </table>
          </div>
        </section>

        <!-- LEADERBOARD SECTION -->
        <section id="leaderboard-section" class="glass p-6 shadow-lg hidden">
          <h2 class="text-2xl font-semibold text-[#6a4c93] mb-4">ğŸ† Leaderboard (Top 10)</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white/70 rounded-xl">
              <thead class="bg-[#cdb4db]/50">
                <tr>
                  <th class="py-2 px-4 border-b">Username</th>
                  <th class="py-2 px-4 border-b">Score</th>
                </tr>
              </thead>
              <tbody id="leaderboard-table"></tbody>
            </table>
          </div>
        </section>

        <!-- MESSAGES SECTION -->
        <section id="messages-section" class="glass p-6 shadow-lg hidden">
          <h2 class="text-2xl font-semibold text-[#6a4c93] mb-4">ğŸ’¬ Contact Messages</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white/70 rounded-xl">
              <thead class="bg-[#cdb4db]/50">
                <tr>
                  <th class="py-2 px-4 border-b">ID</th>
                  <th class="py-2 px-4 border-b">Name</th>
                  <th class="py-2 px-4 border-b">Email</th>
                  <th class="py-2 px-4 border-b">Message</th>
                  <th class="py-2 px-4 border-b">Reply</th>
                  <th class="py-2 px-4 border-b">Action</th>
                </tr>
              </thead>
              <tbody id="messages-table"></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </section>

  <!-- USER DETAILS MODAL -->
  <div id="userDetailsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-xl w-[90%] max-w-lg p-6 relative">
      <h3 class="text-xl font-bold text-[#6a4c93] mb-4">ğŸ‘¤ User Update Details</h3>
      <div id="userDetailsContent" class="text-gray-700 space-y-2 max-h-96 overflow-y-auto"></div>
      <button onclick="closeUserModal()"
        class="absolute top-3 right-3 bg-[#cdb4db] text-white px-3 py-1 rounded-lg hover:bg-[#a06cd5] transition">
        âœ–
      </button>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8080/api/admin";

    // ===== LOGIN =====
    function adminLogin() {
      const email = document.getElementById("admin-email").value;
      const password = document.getElementById("admin-password").value;

      fetch(`${API_BASE}/login?email=${email}&password=${password}`, { method: "POST" })
        .then(res => {
          if (!res.ok) throw new Error("Invalid admin credentials");
          return res.text();
        })
        .then(() => {
          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");
          loadUsers();
          loadLeaderboard();
          loadMessages();
        })
        .catch(err => {
          document.getElementById("login-error").innerText = err.message;
        });
    }

    // ===== LOGOUT =====
    function logout() {
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("login-section").classList.remove("hidden");
    }

    // ===== SWITCH BETWEEN SECTIONS =====
    function showSection(id) {
      document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    // ===== LOAD USERS =====
    function loadUsers() {
      fetch(`${API_BASE}/users`)
        .then(res => res.json())
        .then(users => {
          const tbody = document.getElementById("users-table");
          tbody.innerHTML = "";
          users.forEach(u => {
            tbody.innerHTML += `
              <tr class="hover:bg-[#ffc8dd]/30 transition">
                <td class="py-2 px-4 border-b">${u.id}</td>
                <td class="py-2 px-4 border-b">${u.username}</td>
                <td class="py-2 px-4 border-b">${u.email}</td>
                <td class="py-2 px-4 border-b">${u.score}</td>
                <td class="py-2 px-4 border-b">${u.level}</td>
                <td class="py-2 px-4 border-b">${u.updatedAt ? new Date(u.updatedAt).toLocaleString() : 'â€”'}</td>
                <td class="py-2 px-4 border-b">
                  <button onclick="showUserChanges(${u.id})"
                    class="bg-gradient-to-r from-[#cdb4db] to-[#ffc8dd] text-white px-3 py-1 rounded-lg hover:scale-105 transition">
                    Show Details
                  </button>
                </td>
              </tr>`;
          });
        });
    }

    // ===== SHOW USER CHANGES =====
    function showUserChanges(userId) {
      fetch(`${API_BASE}/user-changes/${userId}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert("User not found");
            return;
          }

          const content = document.getElementById("userDetailsContent");
          content.innerHTML = ""; // clear previous content

          const updatedTime = new Date(data["Last Updated"]).toLocaleString();
          let html = `<p class="font-semibold text-[#6a4c93]">ğŸ•’ Last Updated: ${updatedTime}</p><hr class="my-2">`;

          const keys = Object.keys(data).filter(k => k !== "Last Updated");

          if (keys.length === 0) {
            html += `<p class="text-green-600 font-medium">âœ… No changes detected.</p>`;
          } else {
            keys.forEach(key => {
              html += `
                <div class="p-2 bg-[#f8f0fc] rounded-lg">
                  <p class="font-semibold text-[#6a4c93]">${key}</p>
                  <p><span class="font-medium">Old:</span> ${data[key].old}</p>
                  <p><span class="font-medium">New:</span> ${data[key].new}</p>
                </div>`;
            });
          }

          content.innerHTML = html;
          document.getElementById("userDetailsModal").classList.remove("hidden");
        })
        .catch(err => {
          alert("Error loading user details.");
          console.error(err);
        });
    }

    // ===== CLOSE MODAL =====
    function closeUserModal() {
      document.getElementById("userDetailsModal").classList.add("hidden");
    }

    // ===== LOAD LEADERBOARD =====
    function loadLeaderboard() {
      fetch(`${API_BASE}/leaderboard`)
        .then(res => res.json())
        .then(users => {
          const tbody = document.getElementById("leaderboard-table");
          tbody.innerHTML = "";
          users.forEach(u => {
            tbody.innerHTML += `
              <tr class="hover:bg-[#ffc8dd]/30">
                <td class="py-2 px-4 border-b">${u.username}</td>
                <td class="py-2 px-4 border-b">${u.score}</td>
              </tr>`;
          });
        });
    }

    // ===== LOAD MESSAGES =====
    function loadMessages() {
      fetch(`${API_BASE}/messages`)
        .then(res => res.json())
        .then(messages => {
          const tbody = document.getElementById("messages-table");
          tbody.innerHTML = "";
          messages.forEach(m => {
            tbody.innerHTML += `
              <tr class="hover:bg-[#ffc8dd]/30">
                <td class="py-2 px-4 border-b">${m.id}</td>
                <td class="py-2 px-4 border-b">${m.name}</td>
                <td class="py-2 px-4 border-b">${m.email}</td>
                <td class="py-2 px-4 border-b">${m.message}</td>
                <td class="py-2 px-4 border-b">
                  <input id="reply-${m.id}" value="${m.adminReply || ''}" class="border rounded-lg px-2 py-1 w-full">
                </td>
                <td class="py-2 px-4 border-b">
                  <button onclick="replyMessage(${m.id})" class="bg-gradient-to-r from-[#ffc8dd] to-[#cdb4db] text-white px-3 py-1 rounded-lg hover:scale-105 transition">Reply</button>
                </td>
              </tr>`;
          });
        });
    }

    // ===== SEND REPLY =====
    function replyMessage(id) {
      const reply = document.getElementById(`reply-${id}`).value;
      fetch(`${API_BASE}/reply/${id}?reply=${encodeURIComponent(reply)}`, { method: "PUT" })
        .then(res => res.text())
        .then(msg => alert(msg))
        .then(() => loadMessages());
    }

    // ===== AUTO REFRESH USERS =====
    setInterval(() => {
      if (!document.getElementById("dashboard").classList.contains("hidden")) {
        loadUsers();
      }
    }, 10000);
  </script>
</body>
</html>
